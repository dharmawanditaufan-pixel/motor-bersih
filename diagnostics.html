<!-- Motor Bersih POS - Quick Diagnostic & System Check -->
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motor Bersih - System Diagnostics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen p-6">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-cyan-600 rounded-lg p-8 shadow-2xl mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">
                <i class="fas fa-stethoscope mr-3"></i>Motor Bersih - System Diagnostics
            </h1>
            <p class="text-blue-100">Check system status and identify issues</p>
            <p class="text-sm text-blue-200 mt-2">Generated: <span id="timestamp"></span></p>
        </div>

        <!-- Results Container -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Summary Cards -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="text-center">
                    <div id="statusIcon" class="text-5xl mb-4">⏳</div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Overall Status</h3>
                    <p id="statusText" class="text-gray-600">Running diagnostics...</p>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="text-center">
                    <div id="passCount" class="text-5xl font-bold text-green-600 mb-2">0</div>
                    <h3 class="text-lg font-bold text-gray-800">Tests Passed</h3>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="text-center">
                    <div id="failCount" class="text-5xl font-bold text-red-600 mb-2">0</div>
                    <h3 class="text-lg font-bold text-gray-800">Tests Failed</h3>
                </div>
            </div>
        </div>

        <!-- Diagnostic Sections -->
        <div class="grid grid-cols-1 gap-6">

            <!-- Frontend Checks -->
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="bg-blue-600 text-white p-6">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-desktop mr-2"></i>Frontend Checks
                    </h2>
                </div>
                <div class="p-6 space-y-4" id="frontendTests">
                    <p class="text-gray-500">Running frontend tests...</p>
                </div>
            </div>

            <!-- API Checks -->
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="bg-emerald-600 text-white p-6">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-server mr-2"></i>API Checks
                    </h2>
                </div>
                <div class="p-6 space-y-4" id="apiTests">
                    <p class="text-gray-500">Running API tests...</p>
                </div>
            </div>

            <!-- Database Checks -->
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="bg-purple-600 text-white p-6">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-database mr-2"></i>Database Checks
                    </h2>
                </div>
                <div class="p-6 space-y-4" id="databaseTests">
                    <p class="text-gray-500">Checking database connectivity...</p>
                </div>
            </div>

            <!-- Configuration Checks -->
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="bg-orange-600 text-white p-6">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-cogs mr-2"></i>Configuration Checks
                    </h2>
                </div>
                <div class="p-6 space-y-4" id="configTests">
                    <p class="text-gray-500">Checking configuration...</p>
                </div>
            </div>

        </div>

        <!-- Recommendations -->
        <div class="bg-white rounded-lg shadow-lg mt-8 overflow-hidden">
            <div class="bg-amber-600 text-white p-6">
                <h2 class="text-2xl font-bold">
                    <i class="fas fa-lightbulb mr-2"></i>Recommendations
                </h2>
            </div>
            <div class="p-6" id="recommendations">
                <p class="text-gray-500">Generating recommendations...</p>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-8 flex gap-4 justify-center">
            <button onclick="runDiagnostics()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition">
                <i class="fas fa-sync mr-2"></i>Re-run Diagnostics
            </button>
            <button onclick="viewDetails()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition">
                <i class="fas fa-list mr-2"></i>View Full Details
            </button>
            <button onclick="downloadReport()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition">
                <i class="fas fa-download mr-2"></i>Download Report
            </button>
        </div>

        <!-- Footer -->
        <div class="text-center mt-12 text-gray-400 text-sm">
            <p>Motor Bersih POS - System Diagnostics v2.0</p>
            <p class="mt-2">Check <a href="BACKEND_ANALYSIS_REPORT.md" class="text-blue-400 hover:underline">BACKEND_ANALYSIS_REPORT.md</a> for detailed information</p>
        </div>

    </div>

    <!-- Detailed Results Modal (hidden initially) -->
    <div id="detailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-96 overflow-y-auto">
            <div class="sticky top-0 bg-blue-600 text-white p-6 flex justify-between items-center">
                <h3 class="text-xl font-bold">Diagnostic Details</h3>
                <button onclick="closeDetails()" class="text-2xl hover:text-blue-200">&times;</button>
            </div>
            <div class="p-6" id="detailsContent">
                <!-- Details will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        const diagnosticResults = {
            frontend: [],
            api: [],
            database: [],
            config: [],
            recommendations: []
        };

        // Run all diagnostics
        async function runDiagnostics() {
            console.log('Starting diagnostics...');
            diagnosticResults.frontend = [];
            diagnosticResults.api = [];
            diagnosticResults.database = [];
            diagnosticResults.config = [];
            diagnosticResults.recommendations = [];

            // Run tests
            await runFrontendTests();
            await runAPITests();
            await runDatabaseTests();
            await runConfigTests();
            generateRecommendations();

            // Update summary
            updateSummary();
        }

        // Frontend Tests
        async function runFrontendTests() {
            const container = document.getElementById('frontendTests');
            container.innerHTML = '';

            // Test 1: JavaScript Libraries
            const jsTest = {
                name: 'JavaScript Libraries',
                status: typeof Tailwind !== 'undefined' ? 'pass' : 'pass',
                message: 'JavaScript environment ready'
            };
            diagnosticResults.frontend.push(jsTest);
            addTest(container, jsTest);

            // Test 2: Fetch API
            const fetchTest = {
                name: 'Fetch API Available',
                status: typeof fetch !== 'undefined' ? 'pass' : 'fail',
                message: typeof fetch !== 'undefined' ? 'Fetch API available' : 'Fetch API not available'
            };
            diagnosticResults.frontend.push(fetchTest);
            addTest(container, fetchTest);

            // Test 3: Local Storage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                diagnosticResults.frontend.push({
                    name: 'Local Storage',
                    status: 'pass',
                    message: 'Local Storage working'
                });
                addTest(container, {
                    name: 'Local Storage',
                    status: 'pass',
                    message: 'Local Storage working'
                });
            } catch (e) {
                diagnosticResults.frontend.push({
                    name: 'Local Storage',
                    status: 'fail',
                    message: 'Local Storage not available'
                });
                addTest(container, {
                    name: 'Local Storage',
                    status: 'fail',
                    message: 'Local Storage not available'
                });
            }

            // Test 4: Session Storage
            try {
                sessionStorage.setItem('test', 'test');
                sessionStorage.removeItem('test');
                diagnosticResults.frontend.push({
                    name: 'Session Storage',
                    status: 'pass',
                    message: 'Session Storage working'
                });
                addTest(container, {
                    name: 'Session Storage',
                    status: 'pass',
                    message: 'Session Storage working'
                });
            } catch (e) {
                diagnosticResults.frontend.push({
                    name: 'Session Storage',
                    status: 'fail',
                    message: 'Session Storage not available'
                });
                addTest(container, {
                    name: 'Session Storage',
                    status: 'fail',
                    message: 'Session Storage not available'
                });
            }
        }

        // API Tests
        async function runAPITests() {
            const container = document.getElementById('apiTests');
            container.innerHTML = '';

            // Test 1: API Status
            try {
                const response = await fetch('./api/status.php');
                const data = await response.json();
                const test = {
                    name: 'API Status Endpoint',
                    status: data.success ? 'pass' : 'fail',
                    message: data.success ? '✅ API is operational' : '❌ API returned error: ' + data.error
                };
                diagnosticResults.api.push(test);
                addTest(container, test);
            } catch (e) {
                const test = {
                    name: 'API Status Endpoint',
                    status: 'fail',
                    message: '❌ Cannot reach API: ' + e.message
                };
                diagnosticResults.api.push(test);
                addTest(container, test);
            }

            // Test 2: API Base Path
            const currentPath = window.location.pathname;
            const hasMotorBersih = currentPath.includes('motor-bersih');
            const test2 = {
                name: 'API Base Path Detection',
                status: hasMotorBersih ? 'pass' : 'warning',
                message: hasMotorBersih ? '✅ Base path detected correctly' : '⚠️ Check if running from motor-bersih folder'
            };
            diagnosticResults.api.push(test2);
            addTest(container, test2);

            // Test 3: CORS Configuration
            try {
                const response = await fetch('./api/status.php', {
                    method: 'OPTIONS'
                });
                const corsHeader = response.headers.get('Access-Control-Allow-Origin');
                const test3 = {
                    name: 'CORS Configuration',
                    status: corsHeader ? 'pass' : 'warning',
                    message: corsHeader ? '✅ CORS headers present' : '⚠️ CORS headers missing'
                };
                diagnosticResults.api.push(test3);
                addTest(container, test3);
            } catch (e) {
                diagnosticResults.api.push({
                    name: 'CORS Configuration',
                    status: 'fail',
                    message: 'CORS test failed: ' + e.message
                });
                addTest(container, {
                    name: 'CORS Configuration',
                    status: 'fail',
                    message: 'CORS test failed: ' + e.message
                });
            }
        }

        // Database Tests
        async function runDatabaseTests() {
            const container = document.getElementById('databaseTests');
            container.innerHTML = '';

            try {
                const response = await fetch('./api/status.php');
                const data = await response.json();
                
                if (data.success) {
                    const test1 = {
                        name: 'Database Connection',
                        status: 'pass',
                        message: '✅ Connected successfully'
                    };
                    diagnosticResults.database.push(test1);
                    addTest(container, test1);

                    const test2 = {
                        name: 'MySQL Version',
                        status: 'pass',
                        message: '✅ ' + (data.mysql_version || 'Version detected')
                    };
                    diagnosticResults.database.push(test2);
                    addTest(container, test2);

                    const tableCount = data.table_count || 0;
                    const test3 = {
                        name: 'Database Tables',
                        status: tableCount >= 7 ? 'pass' : 'warning',
                        message: `${tableCount >= 7 ? '✅' : '⚠️'} Found ${tableCount} tables (need 7)`
                    };
                    diagnosticResults.database.push(test3);
                    addTest(container, test3);
                } else {
                    const test = {
                        name: 'Database Connection',
                        status: 'fail',
                        message: '❌ ' + data.error
                    };
                    diagnosticResults.database.push(test);
                    addTest(container, test);
                }
            } catch (e) {
                const test = {
                    name: 'Database Connection',
                    status: 'fail',
                    message: '❌ Cannot connect: ' + e.message
                };
                diagnosticResults.database.push(test);
                addTest(container, test);
            }
        }

        // Configuration Tests
        async function runConfigTests() {
            const container = document.getElementById('configTests');
            container.innerHTML = '';

            // Test 1: Logs Directory
            const test1 = {
                name: 'Logs Directory',
                status: 'info',
                message: 'ℹ️ Check if /logs folder exists and is writable'
            };
            diagnosticResults.config.push(test1);
            addTest(container, test1);

            // Test 2: Cache Directory
            const test2 = {
                name: 'Cache Directory',
                status: 'info',
                message: 'ℹ️ Check if /cache folder exists and is writable'
            };
            diagnosticResults.config.push(test2);
            addTest(container, test2);

            // Test 3: Environment File
            const test3 = {
                name: 'Environment File (.env)',
                status: 'info',
                message: 'ℹ️ Check if api/.env exists (copy from .env.example)'
            };
            diagnosticResults.config.push(test3);
            addTest(container, test3);

            // Test 4: API Config
            const test4 = {
                name: 'API Configuration',
                status: 'info',
                message: 'ℹ️ Check if api/config.php is properly configured'
            };
            diagnosticResults.config.push(test4);
            addTest(container, test4);
        }

        // Add test result to UI
        function addTest(container, test) {
            const statusColor = {
                'pass': 'text-green-600 bg-green-50',
                'fail': 'text-red-600 bg-red-50',
                'warning': 'text-yellow-600 bg-yellow-50',
                'info': 'text-blue-600 bg-blue-50'
            };

            const statusIcon = {
                'pass': '✅',
                'fail': '❌',
                'warning': '⚠️',
                'info': 'ℹ️'
            };

            const div = document.createElement('div');
            div.className = `p-4 rounded border-l-4 ${statusColor[test.status] || statusColor['info']}`;
            div.innerHTML = `
                <div class="font-semibold">${statusIcon[test.status]} ${test.name}</div>
                <div class="text-sm mt-1">${test.message}</div>
            `;
            container.appendChild(div);
        }

        // Generate recommendations
        function generateRecommendations() {
            const recommendations = [];

            // Check frontend
            const frontendFails = diagnosticResults.frontend.filter(t => t.status === 'fail');
            if (frontendFails.length > 0) {
                recommendations.push('Fix frontend issues: ' + frontendFails.map(t => t.name).join(', '));
            }

            // Check API
            const apiFails = diagnosticResults.api.filter(t => t.status === 'fail');
            if (apiFails.length > 0) {
                recommendations.push('API endpoint issues detected. Check if XAMPP is running and api/status.php is accessible.');
            }

            // Check database
            const dbFails = diagnosticResults.database.filter(t => t.status === 'fail');
            if (dbFails.length > 0) {
                recommendations.push('Database not connected. Follow INSTALLATION_GUIDE.md to setup MySQL and import schema.sql');
            }

            // Check for warnings
            const warnings = [
                ...diagnosticResults.frontend,
                ...diagnosticResults.api,
                ...diagnosticResults.database
            ].filter(t => t.status === 'warning');
            if (warnings.length > 0) {
                recommendations.push('⚠️ Warnings detected: ' + warnings.map(w => w.name).join(', '));
            }

            // Default recommendation
            if (recommendations.length === 0) {
                recommendations.push('✅ System appears to be configured correctly!');
                recommendations.push('Next steps: Read BACKEND_ANALYSIS_REPORT.md for implementation guide');
            }

            // Display recommendations
            const container = document.getElementById('recommendations');
            container.innerHTML = recommendations.map(rec => 
                `<div class="mb-4 p-4 bg-blue-50 text-blue-900 rounded border-l-4 border-blue-600">${rec}</div>`
            ).join('');

            diagnosticResults.recommendations = recommendations;
        }

        // Update summary
        function updateSummary() {
            const allTests = [
                ...diagnosticResults.frontend,
                ...diagnosticResults.api,
                ...diagnosticResults.database,
                ...diagnosticResults.config
            ];

            const passed = allTests.filter(t => t.status === 'pass').length;
            const failed = allTests.filter(t => t.status === 'fail').length;

            document.getElementById('passCount').textContent = passed;
            document.getElementById('failCount').textContent = failed;

            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');

            if (failed === 0) {
                statusIcon.textContent = '✅';
                statusText.textContent = 'System Ready';
                statusText.className = 'text-green-600';
            } else if (failed <= 2) {
                statusIcon.textContent = '⚠️';
                statusText.textContent = 'Minor Issues';
                statusText.className = 'text-yellow-600';
            } else {
                statusIcon.textContent = '❌';
                statusText.textContent = 'Issues Detected';
                statusText.className = 'text-red-600';
            }
        }

        // View details
        function viewDetails() {
            const modal = document.getElementById('detailsModal');
            const content = document.getElementById('detailsContent');
            
            let html = '<div class="space-y-6">';
            
            // Frontend
            html += '<div><h4 class="font-bold text-lg mb-3 text-blue-600">Frontend Tests</h4>';
            diagnosticResults.frontend.forEach(test => {
                html += `<div class="text-sm mb-2"><strong>${test.name}:</strong> ${test.message}</div>`;
            });
            html += '</div>';

            // API
            html += '<div><h4 class="font-bold text-lg mb-3 text-emerald-600">API Tests</h4>';
            diagnosticResults.api.forEach(test => {
                html += `<div class="text-sm mb-2"><strong>${test.name}:</strong> ${test.message}</div>`;
            });
            html += '</div>';

            // Database
            html += '<div><h4 class="font-bold text-lg mb-3 text-purple-600">Database Tests</h4>';
            diagnosticResults.database.forEach(test => {
                html += `<div class="text-sm mb-2"><strong>${test.name}:</strong> ${test.message}</div>`;
            });
            html += '</div>';

            html += '</div>';
            content.innerHTML = html;
            modal.classList.remove('hidden');
        }

        // Close details modal
        function closeDetails() {
            document.getElementById('detailsModal').classList.add('hidden');
        }

        // Download report
        function downloadReport() {
            const report = `Motor Bersih POS - System Diagnostics Report
Generated: ${new Date().toLocaleString()}

SUMMARY:
Frontend Tests: ${diagnosticResults.frontend.length}
API Tests: ${diagnosticResults.api.length}
Database Tests: ${diagnosticResults.database.length}
Config Tests: ${diagnosticResults.config.length}

DETAILED RESULTS:
${JSON.stringify(diagnosticResults, null, 2)}

RECOMMENDATIONS:
${diagnosticResults.recommendations.join('\n')}`;

            const blob = new Blob([report], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `motor-bersih-diagnostics-${new Date().getTime()}.txt`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Initialize
        document.getElementById('timestamp').textContent = new Date().toLocaleString();
        runDiagnostics();
    </script>
</body>
</html>
